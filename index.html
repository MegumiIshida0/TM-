<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teachable Machine Image Model - File Upload</title>
  <style>
    .progress-bar {
      width: 100%;
      background-color: #f3f3f3;
    }
    .progress-bar-fill {
      height: 20px;
      width: 0%;
      background-color: #4caf50;
      text-align: center;
      line-height: 20px;
      color: white;
    }
  </style>
</head>
<body>
  <h1>Image Classification using Teachable Machine</h1>
  <p>Upload an image to classify it as "フォーマル", "水着", or "その他".</p>

  <!-- ファイル入力 -->
  <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
  <br><br>

  <!-- キャンバス -->
  <canvas id="canvas" width="320" height="320"></canvas>
  <br>

  <!-- 結果表示 -->
  <div>
    <p>フォーマル:</p>
    <div class="progress-bar"><div class="progress-bar-fill" id="formal-bar"></div></div>
    <p>水着:</p>
    <div class="progress-bar"><div class="progress-bar-fill" id="swimsuit-bar"></div></div>
    <p>その他:</p>
    <div class="progress-bar"><div class="progress-bar-fill" id="other-bar"></div></div>
  </div>

  <p>Prediction: <span id="prediction">Waiting for image...</span></p>

  <!-- ライブラリ読み込み -->
  <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>

  <script type="text/javascript">
    // モデルURL
    const imageModelURL = 'https://teachablemachine.withgoogle.com/models/O2CXrhSLy/model.json';
    
    // クラス分類器変数
    let classifier;
    let canvas, context;

    // モデルの読み込み
    function preload() {
      console.log("Loading model...");
      classifier = ml5.imageClassifier(imageModelURL, modelReady);
    }

    // モデルが準備完了した時に呼び出される
    function modelReady() {
      console.log("Model loaded successfully");
      document.getElementById('prediction').innerText = "Model Loaded. Please upload an image.";
    }

    // 画像プレビューと分類開始
    function previewImage() {
      const file = document.getElementById('imageInput').files[0];
      if (file) {
        const reader = new FileReader();
        
        reader.onload = function(event) {
          const img = new Image();
          img.onload = function() {
            canvas = document.getElementById('canvas');
            context = canvas.getContext('2d');
            context.clearRect(0, 0, canvas.width, canvas.height);

            // 画像のアスペクト比を維持してキャンバスに描画
            const aspectRatio = img.width / img.height;
            let newWidth, newHeight;
            if (aspectRatio > 1) {  // 横長の場合
              newWidth = canvas.width;
              newHeight = canvas.width / aspectRatio;
            } else {  // 縦長の場合
              newHeight = canvas.height;
              newWidth = canvas.height * aspectRatio;
            }
            
            context.drawImage(img, 0, 0, newWidth, newHeight);
            console.log("Image drawn to canvas");

            classifyImage(canvas);  // キャンバスに描画した画像を分類
          }
          img.onerror = function() {
            console.error("Image failed to load");
            document.getElementById('prediction').innerText = "Error: Could not load image.";
          }
          img.src = event.target.result;
        }
        reader.onerror = function() {
          console.error("File could not be read");
          document.getElementById('prediction').innerText = "Error: Could not read file.";
        }
        reader.readAsDataURL(file);  // Base64形式で読み込み
      } else {
        console.error("No file selected");
        document.getElementById('prediction').innerText = "Error: No file selected.";
      }
    }

    // 画像分類の実行
    function classifyImage(image) {
      console.log("Classifying image...");
      classifier.classify(image, function(err, results) {
        if (err) {
          console.error('Classification Error: ', err);
          document.getElementById('prediction').innerText = "Error during classification.";
          return;
        }

        console.log('Classification results:', results);

        if (results.length > 0) {
          // 結果を出力バーに反映
          updateProgressBar('formal-bar', results, 'フォーマル');
          updateProgressBar('swimsuit-bar', results, '水着');
          updateProgressBar('other-bar', results, 'その他');

          document.getElementById('prediction').innerText = "Prediction: " + results[0].label;
        } else {
          document.getElementById('prediction').innerText = "Error: No classification results.";
        }
      });
    }

    // プログレスバーを更新
    function updateProgressBar(barId, results, label) {
      const result = results.find(r => r.label === label);
      if (result) {
        const percentage = Math.round(result.confidence * 100);
        document.getElementById(barId).style.width = percentage + '%';
        document.getElementById(barId).innerText = percentage + '%';
      } else {
        document.getElementById(barId).style.width = '0%';
        document.getElementById(barId).innerText = '0%';
      }
    }

    // モデルを読み込み
    preload();
  </script>
</body>
</html>
