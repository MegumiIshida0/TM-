<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teachable Machine Image Model - Photo Classification</title>
</head>
<body>
  <div>
    <h1>Image Classification using Teachable Machine</h1>
    <p>Upload an image to classify it as "フォーマル", "水着", or "その他".</p>
    <input type="file" id="imageInput" accept="image/*" onchange="previewImage()">
    <br><br>
    <canvas id="canvas" width="320" height="320"></canvas>
    <br>
    <p>Prediction: <span id="prediction">Loading...</span></p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/p5@1.4.0/lib/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@latest/dist/ml5.min.js"></script>
  
  <script type="text/javascript">
    // モデルのURL
    const imageModelURL = 'https://teachablemachine.withgoogle.com/models/O2CXrhSLy/'; // Teachable MachineのモデルURL
    
    // クラス分類器変数
    let classifier;
    let canvas, context;
    let imageInput;

    // モデルの読み込み
    function preload() {
      console.log("Loading model..."); // モデル読み込み開始のログ
      classifier = ml5.imageClassifier(imageModelURL + 'model.json', modelReady);
    }

    // モデルが準備できた時に呼び出される関数
    function modelReady() {
      console.log('Model loaded successfully');  // モデル読み込み成功のログ
      document.getElementById('prediction').innerText = "Model Loaded. Please upload an image.";
    }

    // 画像のプレビューと分類を開始
    function previewImage() {
      const file = document.getElementById('imageInput').files[0];
      const reader = new FileReader();
      reader.onload = function(event) {
        const img = new Image();
        img.onload = function() {
          canvas = document.getElementById('canvas');
          context = canvas.getContext('2d');
          context.clearRect(0, 0, canvas.width, canvas.height);
          
          // 画像をキャンバスにリサイズして描画
          const aspectRatio = img.width / img.height;
          let newWidth, newHeight;
          if (aspectRatio > 1) {  // 横長の場合
            newWidth = canvas.width;
            newHeight = canvas.width / aspectRatio;
          } else {  // 縦長の場合
            newHeight = canvas.height;
            newWidth = canvas.height * aspectRatio;
          }
          context.drawImage(img, 0, 0, newWidth, newHeight);
          
          classifyImage(img);  // 画像を分類
        }
        img.src = event.target.result;
      }
      reader.readAsDataURL(file);
    }

    // 画像の分類を行う
    function classifyImage(img) {
      classifier.classify(img, function(err, results) {
        if (err) {
          console.error('Error during classification:', err);  // エラー発生時のログ
          document.getElementById('prediction').innerText = "Error during classification. Please try again.";
          return;
        }
        console.log('Classification results:', results);  // 分類結果のログ
        document.getElementById('prediction').innerText = results[0].label;  // 結果を表示
      });
    }

    // 初期化
    preload();
  </script>
</body>
</html>
